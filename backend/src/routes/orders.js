const express=require('express');const router=express.Router();const auth=require('../middleware/auth');const {Order,OrderItem,MenuItem,User,Restaurant}=require('../models');
router.post('/',auth,async(req,res)=>{try{const {items}=req.body;if(!Array.isArray(items)||!items.length)return res.status(400).json({error:'Invalid items'});const ids=items.map(i=>i.menuItemId);const menu=await MenuItem.findAll({where:{id:ids},include:[Restaurant]});const map=Object.fromEntries(menu.map(m=>[m.id,m]));let total=0;for(const it of items){const m=map[it.menuItemId];if(!m)return res.status(400).json({error:'Bad item'});total+=m.price*(it.quantity||1);}const order=await Order.create({total,UserId:req.user.id});for(const it of items){const m=map[it.menuItemId];await OrderItem.create({OrderId:order.id,MenuItemId:m.id,quantity:it.quantity||1,price:m.price});}res.status(201).json(await Order.findByPk(order.id,{include:[{model:OrderItem,include:[{model:MenuItem,include:[Restaurant]}]},{model:User,attributes:['id','name','email']}]}));}catch(e){res.status(500).json({error:'Order failed'})}});
router.get('/',auth,async(req,res)=>res.json(await Order.findAll({where:{UserId:req.user.id},include:[{model:OrderItem,include:[{model:MenuItem,include:[Restaurant]}]},{model:User,attributes:['id','name','email']}]})));
module.exports=router;